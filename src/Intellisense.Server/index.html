<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>F# Autocomplete Demo</title>
    <link rel="stylesheet" href="content/css/codemirror.css">
    <link rel="stylesheet" href="content/css/simple-hint.css">
  </head>
  <body>
    <h1>F# Autocomplete Demo</h1>

    <form>
      <textarea id="code" name="code">let who = "world"
printfn "Hello, %s"</textarea>
    </form>

    <p>Press Ctrl+Space for autocompletion.</p>

    <script src="content/js/codemirror.js"></script>
    <script src="content/js/codemirror-fsharp.js"></script>
    <script src="content/js/simple-hint.js"></script>
    <script src="content/js/jquery.min.js"></script>
    <script>
      function getHints(editor, _, cont) {
        var cur = editor.getCursor(), token = editor.getTokenAt(cur);
        var prefix = editor.getLine(cur.line).slice(token.start, cur.ch).trim();
        console.log(prefix);

        $.ajax({
          url: "draft/1/cell/1/code?line=" + cur.line + "&column=" + cur.ch,
          contentType: "text/plain",
          data: editor.getValue(),
          dataType: "json",
          type: "PUT",
          success: function(response) {
            var i = 0, c = response.Completions;

            if (prefix.length) {
              while (i < c.length) {
                if (c[i].indexOf(prefix) == 0) {
                  i++;
                } else {
                  c.splice(i, 1);
                }
              }
            }

            cont({
              list: c,
              from: { line: cur.line, ch: token.start },
              to: { line: cur.line, ch: token.end }
            });
          }
        });
      }

      CodeMirror.commands.autocomplete = function(cm) {
        CodeMirror.simpleHint(cm, getHints, { closeOnBackspace: false });
      };

      var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        extraKeys: {"Ctrl-Space": "autocomplete"},
        mode: "fsharp"
      });
    </script>
  </body>
</html>
